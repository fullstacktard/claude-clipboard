#!/bin/bash
# Stage clipboard images for later pasting all at once

STAGING_DIR="${HOME}/.cache/claude-clipboard-staging"
mkdir -p "$STAGING_DIR"

# Generate unique filename with timestamp
TIMESTAMP=$(date +%Y%m%d_%H%M%S_%N)
TEMP_FILE="${STAGING_DIR}/staged_${TIMESTAMP}.png"
WIN_PATH=$(wslpath -w "$TEMP_FILE")

# PowerShell command to save image
POWERSHELL_CMD="
\$image = Get-Clipboard -Format Image
if (\$image) {
    try {
        \$image.Save('$WIN_PATH', [System.Drawing.Imaging.ImageFormat]::Png)
        Write-Host 'SUCCESS'
    } catch {
        Write-Host 'ERROR'
    }
} else {
    Write-Host 'NONE'
}
"

RESULT=$(powershell.exe -Command "$POWERSHELL_CMD" 2>&1 | tr -d '\r')

case "$RESULT" in
    SUCCESS)
        if [ -f "$TEMP_FILE" ]; then
            # Count how many images are staged
            COUNT=$(ls -1 "$STAGING_DIR"/staged_*.png 2>/dev/null | wc -l)
            SIZE=$(du -h "$TEMP_FILE" | cut -f1)
            echo "âœ“ Staged image #$COUNT ($SIZE)" >&2
            echo "ðŸ“¸ Take another screenshot and stage it, or run 'cbflush' to paste all" >&2
            # Return the path silently
            echo "$TEMP_FILE"
        else
            echo "âœ— Error: Failed to save image" >&2
            exit 1
        fi
        ;;
    NONE)
        echo "âœ— No image in clipboard" >&2
        exit 1
        ;;
    *)
        echo "âœ— Error: $RESULT" >&2
        exit 1
        ;;
esac
